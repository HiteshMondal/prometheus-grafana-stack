groups:
  # Node/Host level aggregations
  - name: node_recording_rules
    interval: 30s
    rules:
      # CPU Usage
      - record: instance:node_cpu_utilization:rate5m
        expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

      - record: instance:node_cpu_utilization:rate1m
        expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[1m])) * 100)

      # Memory Usage
      - record: instance:node_memory_utilization:ratio
        expr: |
          (
            1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)
          ) * 100

      # Disk Usage
      - record: instance:node_disk_utilization:ratio
        expr: |
          (
            1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})
          ) * 100

      # Network Traffic
      - record: instance:node_network_receive_bytes:rate5m
        expr: rate(node_network_receive_bytes_total[5m])

      - record: instance:node_network_transmit_bytes:rate5m
        expr: rate(node_network_transmit_bytes_total[5m])

      # Disk I/O
      - record: instance:node_disk_read_bytes:rate5m
        expr: rate(node_disk_read_bytes_total[5m])

      - record: instance:node_disk_written_bytes:rate5m
        expr: rate(node_disk_written_bytes_total[5m])

  # Container level aggregations
  - name: container_recording_rules
    interval: 30s
    rules:
      # Container CPU usage
      - record: container:cpu_usage:rate5m
        expr: rate(container_cpu_usage_seconds_total{name!=""}[5m]) * 100

      # Container memory usage
      - record: container:memory_usage:ratio
        expr: |
          (
            container_memory_usage_bytes{name!=""} / 
            container_spec_memory_limit_bytes{name!=""} > 0
          ) * 100

      # Container network receive
      - record: container:network_receive_bytes:rate5m
        expr: rate(container_network_receive_bytes_total{name!=""}[5m])

      # Container network transmit
      - record: container:network_transmit_bytes:rate5m
        expr: rate(container_network_transmit_bytes_total{name!=""}[5m])

  # Application level aggregations (HTTP)
  - name: http_recording_rules
    interval: 30s
    rules:
      # Request rate
      - record: job:http_requests:rate5m
        expr: sum by (job) (rate(http_requests_total[5m]))

      # Request rate by status
      - record: job:http_requests_by_status:rate5m
        expr: sum by (job, status) (rate(http_requests_total[5m]))

      # Error rate
      - record: job:http_errors:rate5m
        expr: sum by (job) (rate(http_requests_total{status=~"5.."}[5m]))

      # Error ratio
      - record: job:http_error_ratio:rate5m
        expr: |
          sum by (job) (rate(http_requests_total{status=~"5.."}[5m]))
          /
          sum by (job) (rate(http_requests_total[5m]))

      # Latency aggregations
      - record: job:http_request_duration_seconds:p50
        expr: histogram_quantile(0.5, sum by (job, le) (rate(http_request_duration_seconds_bucket[5m])))

      - record: job:http_request_duration_seconds:p95
        expr: histogram_quantile(0.95, sum by (job, le) (rate(http_request_duration_seconds_bucket[5m])))

      - record: job:http_request_duration_seconds:p99
        expr: histogram_quantile(0.99, sum by (job, le) (rate(http_request_duration_seconds_bucket[5m])))

  # Endpoint monitoring aggregations
  - name: probe_recording_rules
    interval: 30s
    rules:
      # Probe success rate
      - record: instance:probe_success:rate5m
        expr: avg_over_time(probe_success[5m])

      # Probe duration
      - record: instance:probe_duration:avg5m
        expr: avg_over_time(probe_duration_seconds[5m])

      # SSL cert expiry days
      - record: instance:ssl_cert_expiry_days
        expr: (probe_ssl_earliest_cert_expiry - time()) / 86400

  # Prometheus self-monitoring
  - name: prometheus_recording_rules
    interval: 30s
    rules:
      # Sample ingestion rate
      - record: prometheus:sample_ingestion:rate5m
        expr: rate(prometheus_tsdb_head_samples_appended_total[5m])

      # Query rate
      - record: prometheus:queries:rate5m
        expr: rate(prometheus_http_requests_total{handler="/api/v1/query"}[5m])

      # Query duration
      - record: prometheus:query_duration:p95
        expr: histogram_quantile(0.95, rate(prometheus_engine_query_duration_seconds_bucket[5m]))

      # Storage size
      - record: prometheus:storage_size_bytes
        expr: prometheus_tsdb_storage_blocks_bytes

  # Business metrics aggregations
  - name: business_recording_rules
    interval: 1m
    rules:
      # Total active users (example)
      - record: business:active_users:total
        expr: sum(active_users)

      # Revenue per second (example)
      - record: business:revenue_per_second:rate5m
        expr: sum(rate(revenue_total[5m]))

      # Conversion rate (example)
      - record: business:conversion_rate:rate5m
        expr: |
          sum(rate(conversions_total[5m]))
          /
          sum(rate(page_views_total[5m]))

  # SLI/SLO calculations
  - name: sli_recording_rules
    interval: 30s
    rules:
      # Availability SLI (99.9% target)
      - record: sli:availability:rate5m
        expr: |
          sum(rate(http_requests_total{status!~"5.."}[5m]))
          /
          sum(rate(http_requests_total[5m]))

      # Latency SLI (95% < 500ms)
      - record: sli:latency:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))

      # Error budget remaining (monthly)
      - record: sli:error_budget:remaining
        expr: |
          1 - (
            (1 - sum(rate(http_requests_total{status!~"5.."}[30d])) / sum(rate(http_requests_total[30d])))
            /
            (1 - 0.999)
          )

  # Cluster-wide aggregations
  - name: cluster_recording_rules
    interval: 1m
    rules:
      # Total cluster CPU
      - record: cluster:cpu_utilization:avg
        expr: avg(instance:node_cpu_utilization:rate5m)

      # Total cluster memory
      - record: cluster:memory_utilization:avg
        expr: avg(instance:node_memory_utilization:ratio)

      # Total cluster disk
      - record: cluster:disk_utilization:avg
        expr: avg(instance:node_disk_utilization:ratio)

      # Total requests per second
      - record: cluster:http_requests_total:rate5m
        expr: sum(rate(http_requests_total[5m]))

      # Cluster-wide error rate
      - record: cluster:http_error_rate:rate5m
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total[5m]))

  # Team-based aggregations
  - name: team_recording_rules
    interval: 1m
    rules:
      # Requests per team
      - record: team:http_requests:rate5m
        expr: sum by (team) (rate(http_requests_total[5m]))

      # Errors per team
      - record: team:http_errors:rate5m
        expr: sum by (team) (rate(http_requests_total{status=~"5.."}[5m]))

      # CPU usage per team
      - record: team:cpu_utilization:avg
        expr: avg by (team) (instance:node_cpu_utilization:rate5m)

      # Memory usage per team
      - record: team:memory_utilization:avg
        expr: avg by (team) (instance:node_memory_utilization:ratio)